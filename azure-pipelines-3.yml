trigger: none

parameters:
  - name: customerName
    displayName: "Enter Customer Name (full name)"
    type: string

  - name: locationa
    displayName: "Azure Region"
    type: string
    default: "westeurope"

  - name: environment
    displayName: "Environment"
    type: string
    values:
      - dev
      - tst
      - prd
      - pprd

  - name: userEmail
    displayName: "New SFTP User Email"
    type: string

  - name: permission
    displayName: "Permission (read/write)"
    type: string
    values:
      - read
      - write

pool:
  name: Default

steps:

# --------------------------------------------------------
# STEP 1 — Naming Convention
# --------------------------------------------------------
- powershell: |
    $CUSTOMER       = "${{ parameters.customerName }}".ToLower().Replace(" ", "").Replace("'", "")
    $ENVIRONMENT    = "${{ parameters.environment }}"
    $LOCATION       = "${{ parameters.locationa }}"
    $PREFIX         = $CUSTOMER.Substring(0,3)

    # Random is required because storage names must be globally unique
    $STORAGE        = "st$PREFIX$ENVIRONMENT$((Get-Random -Maximum 9999))"
    
    $RESOURCE_GROUP = "rg-$PREFIX-$ENVIRONMENT-sftp"
    $CONTAINER      = "sftp"

    Write-Host "##vso[task.setvariable variable=STORAGE]$STORAGE"
    Write-Host "##vso[task.setvariable variable=RESOURCE_GROUP]$RESOURCE_GROUP"
    Write-Host "##vso[task.setvariable variable=CONTAINER]$CONTAINER"
    Write-Host "##vso[task.setvariable variable=LOCATION]$LOCATION"
  displayName: "Prepare Naming Convention"

# --------------------------------------------------------
# STEP 2 — Create Resource Group
# --------------------------------------------------------
- task: AzureCLI@2
  displayName: "Create Resource Group"
  inputs:
    azureSubscription: "devopsspn"
    scriptType: "ps"
    scriptLocation: "inlineScript"
    inlineScript: |
      az group create -n $env:RESOURCE_GROUP -l $env:LOCATION

# --------------------------------------------------------
# STEP 3 — Create SFTP-Enabled Storage Account (IMPORTANT)
# --------------------------------------------------------
- task: AzureCLI@2
  displayName: "Create SFTP Enabled Storage Account"
  inputs:
    azureSubscription: "devopsspn"
    scriptType: "ps"
    scriptLocation: "inlineScript"
    inlineScript: |
      az storage account create `
        --name $env:STORAGE `
        --resource-group $env:RESOURCE_GROUP `
        --location $env:LOCATION `
        --sku Standard_LRS `
        --kind StorageV2 `
        --enable-hierarchical-namespace true `
        --enable-sftp true `
        --allow-blob-public-access false

# --------------------------------------------------------
# STEP 4 — Create Blob Container
# --------------------------------------------------------
- task: AzureCLI@2
  displayName: "Create Blob Container"
  inputs:
    azureSubscription: "devopsspn"
    scriptType: "ps"
    scriptLocation: "inlineScript"
    inlineScript: |
      az storage container create `
        --account-name $env:STORAGE `
        --name $env:CONTAINER `
        --auth-mode login

# --------------------------------------------------------
# STEP 5 — Create SFTP Local User w/ Correct Permissions
# --------------------------------------------------------
- task: AzureCLI@2
  displayName: "Create SFTP User"
  inputs:
    azureSubscription: "devopsspn"
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      if ("${{ parameters.permission }}" -eq "read") {
        $PERMISSIONS = "Read,List"
      } else {
        $PERMISSIONS = "Read,List,Write,Delete"
      }

      bash -c "
      az storage account local-user create \
        --account-name $STORAGE \
        --username '${{ parameters.userEmail }}' \
        --home-directory '/$CONTAINER' \
        --has-ssh-password true \
        --has-ssh-key false \
        --has-shared-key false \
        --permission-scope permissions=$PERMISSIONS service=blob resource-name=$CONTAINER
      "

        --has-ssh-password true \
        --has-ssh-key false \
        --has-shared-key false \
        --permission-scope permissions=$PERMISSIONS service=blob resource-name=$env:CONTAINER
